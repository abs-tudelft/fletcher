image: docker:latest

stages:
  - check
  - test
  - build
  - examples

# before_script:
#   - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin

.env: &env
  ARROW_VERSION: 0.11.1

  GHDL_IMAGE: ghdl/ghdl
  GHDL_TAG: ubuntu18-llvm-5.0

  RUST_VERSION: 1.30.1
  RUST_VHDL_PARSER_CRATE_VERSION: 0.3.0

  FLETCHER_APT_PACKAGES: cmake g++

variables:
  <<: *env

.apt-install: &apt-install |
  [ "$APT_PACKAGES" ] && apt-get update && apt-get install -y $APT_PACKAGES

hardware:
  stage: check
  image: rust:${RUST_VERSION}-slim-stretch
  before_script:
    - cargo install vhdl_parser --version $RUST_VHDL_PARSER_CRATE_VERSION
    - shopt -s globstar
  script:
    - vhdl_parser --show hardware/**/*.vhd

.ghdl-check-job: &ghdl-check-job
  stage: check
  image: $GHDL_IMAGE:$GHDL_TAG
  script:
    - shopt -s globstar
    - ghdl -i -v --std=${STD:-08} ${SOURCE_PATH:-harware/vhdl}/**/*.vhd |
      grep entity |
      sed -e 's/entity //' |
      sed -e 's/ \*\*//' |
      xargs -L 1 ghdl -m --std=${STD:-08} --ieee=synopsys

hardware/vhdl-93c:
  <<: *ghdl-check-job
  variables:
    <<: *env
    STD: 93c

hardware/vhdl-08:
  <<: *ghdl-check-job

hardware/test-08:
  <<: *ghdl-check-job
  variables:
    <<: *env
    SOURCE_PATH: hardware/test

hardware/test-08:
  <<: *ghdl-check-job
  stage: test
  script:
    - shopt -s globstar
    - ghdl -i -v --std=${STD:-08} ${SOURCE_PATH:-hardware}/**/*.vhd |
      grep entity |
      grep _tb |
      sed -e 's/entity //' |
      sed -e 's/ \*\*//' |
      xargs -i -t bash -c '
      ghdl -m --std=${STD:-08} --ieee=synopsys {};
      ghdl -r --std=${STD:-08} --ieee=synopsys {} --stop-time=100ns'

.cmake-build-job: &cmake-build-job
  stage: build
  image: mbrobbel/libarrow:$ARROW_VERSION
  variables:
    <<: *env
    APT_PACKAGES: $FLETCHER_APT_PACKAGES
  before_script:
    - *apt-install
    - mkdir -p build
  script:
    - pusdh build
    - cmake ../$CI_JOB_NAME
    - make -j

.cmake-test-job: &cmake-test-job
  <<: *cmake-build-job
  stage: test
  variables:
    <<: *env
    APT_PACKAGES: $FLETCHER_APT_PACKAGES libgtest-dev
  script:
    - pushd build
    - cmake -DFLETCHER_TESTS=1 ../$CI_JOB_NAME
    - make -j
    - make test

runtime/cpp:
  <<: *cmake-test-job

common/cpp:
  <<: *cmake-test-job
